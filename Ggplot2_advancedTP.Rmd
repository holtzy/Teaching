---
title: "Advanced data visualization with R and ggplot2"
author: "a practical by [Yan Holtz](https://github.com/holtzy)"
date: "`r format(Sys.time(), '%d %B %Y')`"
mail: "yan.holtz.data@gmail.com"
linkedin: "yan-holtz-2477534a"
twitter: "r_graph_gallery"
github: "holtzy"
home: "www.yan-holtz.com"
output:
  epuRate::epurate:
    toc: TRUE
    number_sections: FALSE
    code_folding: "show"
---

```{r global options, include = FALSE}
knitr::opts_chunk$set( warning=FALSE, message=FALSE)

library(rmarkdown)
library(epuRate)

# If necessary
# library(devtools)
# install_github("holtzy/epuRate")
```

<style>
.questionNumber{
  color: #69b3a2;
  border: solid;
  border-color: #69b3a2;
  padding: 3px;
  border-width: 1px;
  border-radius: 2px;
}
.code-folding-btn {
  display: none;
}

.Correction { display: block }
.Question { display: none }

</style>



<br><br>

> This practical follows the previous basic [introduction to ggplot2](https://www.yan-holtz.com/teaching). It allows to go further with ggplot2: how to annotate a chart, how to build interactive charts, how to customize colors, and more.







# Get ready
***
The following libraries are needed all along the practical. Install them with `install.packages()` if you do not have them already. Then load them with `library()`.
```{r, echo=TRUE}
# Load it
library(ggplot2)
library(dplyr)
library(hrbrthemes)
library(viridis)
```




# 1- General appearance
***

## &rarr; Titles

<br><span class="questionNumber">Q1.1</span> - The code below builds a basic histogram for values under 300. Add code to:

- add a title with `ggtitle()`
- change axis labels `xlab()` and `ylab()`
- change axis limits with `xlim()` and `ylim()`

```{r, class.source='myCorrection'}
# Libraries
library(ggplot2)

# Load dataset from github
data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/1_OneNum.csv", header=TRUE)

# Make the histogram
data %>%
  filter( price<300 ) %>%
  ggplot( aes(x=price)) +
    geom_histogram() +
    ggtitle("Night price distribution of Airbnb appartements") +
    xlab("Night price") +
    ylab("Number of apartments") +
    xlim(0,400)
```


```{r, eval=FALSE, class.source='myQuestion'}
# Libraries
library(ggplot2)

# Load dataset from github
data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/1_OneNum.csv", header=TRUE)

# Make the histogram
data %>%
  filter( price<300 ) %>%
  ggplot( aes(...)) +
    geom_... +
    ggtitle(...) +
    xlab(...
```




## &rarr; Chart components

All `ggplot2` chart components can be changed using the `theme()` function. You can see a complete list of components in the official [documentation](https://ggplot2.tidyverse.org/reference/theme.html).

<br><span class="questionNumber">Q1.2</span> - Reproduce the previous histogram and change:

- plot title size and color with `plot.title`
- X axis title size and color with `axis.title.x`
- Grid appearance with `panel.grid.major`

```{r}
# Make the histogram
data %>%
  filter( price<300 ) %>%
  ggplot( aes(x=price)) +
    geom_histogram() +
    ggtitle("Night price distribution of Airbnb appartements") +
    xlab("Night price") +
    ylab("Number of apartments") +
    xlim(0,400) +
    theme(
      plot.title = element_text(size=13, color="orange"),
      axis.title.x = element_text(size=13, color="purple"),
      panel.grid.major = element_line(colour = "red")
    )
```




## &rarr; Themes

<br><span class="questionNumber">Q1.3</span> - `ggplot2` offers a set of pre-built themes. Try the followings to see which one you like the most:

- `theme_bw()`
- `theme_dark()`
- `theme_minimal()`
- `theme_classic()`

See a complete list [here](https://www.r-graph-gallery.com/192-ggplot-themes/).

```{r}
# Libraries
library(tidyverse)
library(hrbrthemes)
library(viridis)

# Load dataset from github
data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/1_OneNum.csv", header=TRUE)

# Make the histogram
data %>%
  filter( price<300 ) %>%
  ggplot( aes(x=price)) +
    geom_histogram(fill="#69b3a2", color="#e9ecef", alpha=0.9) +
    ggtitle("Night price distribution of Airbnb appartements") +
    theme_classic()
```



<br><span class="questionNumber">Q1.4</span> - The `hrbrthemes` package provides my favourite style. Install the package, load it, and apply the `theme_ipsum()`. Documentation is [here](https://github.com/hrbrmstr/hrbrthemes).


```{r}
# Libraries
library(tidyverse)
library(hrbrthemes)
library(viridis)

# Load dataset from github
data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/1_OneNum.csv", header=TRUE)

# Make the histogram
data %>%
  filter( price<300 ) %>%
  ggplot( aes(x=price)) +
    stat_bin(breaks=seq(0,300,10), fill="#69b3a2", color="#e9ecef", alpha=0.9) +
    ggtitle("Night price distribution of Airbnb appartements") +
    theme_ipsum()
```








# 2- Annotation
***
Annotation is a crucial component of a good dataviz. It can turn a boring graphic into an interesting and insightful way to convey information. Dataviz is often separated in two main types: exploratory and explanatory analysis. Annotation is used for the second type.


## &rarr; Text
The most common type of annotation is text. Let's say you have a spike in a line plot. It totally makes sense to highlight it, and explain more in details what it is about.

<br><span class="questionNumber">Q1.1</span> - Build a line plot showing the bitcoin price evolution between 2013 and 2018. Dataset is located [here]("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/3_TwoNumOrdered.csv") and can be read directly with `read.table()`. What part of the chart would you highlight?

```{r, fig.align="center"}
# Load dataset from github
data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/3_TwoNumOrdered.csv", header=T)
data$date <- as.Date(data$date)

# plot
data %>%
  ggplot( aes(x=date, y=value)) +
    geom_line(color="#69b3a2")
```


<br><span class="questionNumber">Q1.2</span> - Use the `annotate()` function to add text. Annotate requires several arguments:

- `geom`: type of annotation, use `text`
- `x`: position on the X axis
- `y`: position on the Y axis
- `label`: what you want to write
- Optional: `color`, `size`, `angle` and [more](https://www.r-graph-gallery.com/233-add-annotations-on-ggplot2-chart/).


```{r}
# plot
data %>%
  ggplot( aes(x=date, y=value)) +
    geom_line(color="#69b3a2") +
    annotate(geom="text", x=as.Date("2017-01-01"), y=19000, 
             label="Bitcoin price reached 20k $\nat the end of 2017")
```





## &rarr; Shape

<br><span class="questionNumber">Q1.3</span> - To highlight the spike even more, draw a circle around it. Note that you first need to find the exact spike date and its value


```{r, fig.align="center"}
# Find spike date and value:
# data %>% arrange(desc(value)) %>% head(1)

# plot
data %>% 
  ggplot( aes(x=date, y=value)) +
    geom_line(color="#69b3a2") +
    ylim(0,22000) +
    annotate(geom="text", x=as.Date("2017-01-01"), y=20089, 
             label="Bitcoin price reached 20k $\nat the end of 2017") +
    annotate(geom="point", x=as.Date("2017-12-17"), y=20089, size=10, shape=21, fill="transparent")
```



## &rarr; Abline

<br><span class="questionNumber">Q1.4</span> - Add a horizontal abline to show what part of the curve is over 5000 $. This is possible thanks to the `geom_hline()` function that requires its `yintercept` argument.

```{r, fig.align="center"}
# Find spike date and value:
# data %>% arrange(desc(value)) %>% head(1)

# plot
data %>% 
  ggplot( aes(x=date, y=value)) +
    geom_line(color="#69b3a2") +
    ylim(0,22000) +
    annotate(geom="text", x=as.Date("2017-01-01"), y=20089, 
             label="Bitcoin price reached 20k $\nat the end of 2017") +
    annotate(geom="point", x=as.Date("2017-12-17"), y=20089, size=10, shape=21, fill="transparent") +
    geom_hline(yintercept=5000, color="orange", size=.5)
```









## &rarr; Color

<br><span class="questionNumber">Q1.5</span> - Build a scatterplot based on the `gapminder` dataset. Use `gdpPercap` for the X axis, `lifeExp` for the Y axis, and `pop` for bubble size. Keep only the year 2007.

```{r, fig.align="center"}
# Data are available in the gapminder package
library(gapminder)
data <- gapminder %>% filter(year=="2007") %>% select(-year)

# Basic scatterplot
ggplot( data, aes(x=gdpPercap, y=lifeExp, size = pop, color = continent)) +
    geom_point(alpha=0.7) 

```


<br><span class="questionNumber">Q1.6</span> - Highlight South Africa in the chart: draw it in red, with all other circles in grey. Follow those steps:

- create a new column with `mutate`: this new column has the value `yes` if `country=="South Africa"`, `no` otherwise. This is possible thanks to the `??felse` function.
- in the aesthetics part of the ggplot call, use this new column to control dot colors
- use


```{r, fig.align="center"}
# Basic scatterplot
data %>%
  mutate(isSouthAfrica = ifelse(country=="South Africa", "yes", "no")) %>%
  ggplot( aes(x=gdpPercap, y=lifeExp, size = pop, color = isSouthAfrica)) +
    geom_point(alpha=0.7) +
    scale_color_manual(values=c("grey", "red")) +
    theme(legend.position="none")

```




## &rarr; Multiple text

<br><span class="questionNumber">Q1.7</span> - Highlight every country with `gdpPercap > 5000` & `lifeExp < 60` in red. Write their names using the geom_text_repel of the `ggrepel` package

```{r, fig.align="center"}

# ggrepel
library(ggrepel)

# prepare data
tmp <- data %>%
  mutate( annotation = ifelse(gdpPercap > 5000 & lifeExp < 60, "yes", "no"))

# plot
tmp %>%
  ggplot( aes(x=gdpPercap, y=lifeExp, size = pop, color = continent)) +
    geom_point(alpha=0.7) +
    theme(legend.position="none") +
    geom_text_repel(data=tmp %>% filter(annotation=="yes"), aes(label=country), size=4 )
```


## &rarr; Bonus








# 3- Faceting
***


## &rarr; facet_wrap()
```{r}
# Libraries
library(babynames)

# Load dataset from github
data <- babynames %>% 
  filter(name %in% c("Ashley", "Amanda", "Jessica",    "Patricia", "Linda", "Deborah",   "Dorothy", "Betty", "Helen")) %>%
  filter(sex=="F")

# line plot = spaghetti chart
data %>%
  ggplot( aes(x=year, y=n, group=name, color=name)) +
    geom_line() +
    ggtitle("Popularity of American names in the previous 30 years")
```  
  
```{r}
data %>%
  ggplot( aes(x=year, y=n, group=name, fill=name)) +
    geom_area() +
    ggtitle("Popularity of American names in the previous 30 years") +
    theme(
      legend.position="none",
    ) +
    facet_wrap(~name, scale="free_y")
```

## &rarr; facet_grid()

```{r}
# Load dataset from github
data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/10_OneNumSevCatSubgroupsSevObs.csv", header=T, sep=",")

# Plot
ggplot(data, aes(x=total_bill)) +
  geom_histogram() +
  facet_grid(sex~day)
```
  
  
  






# 4- Saving plots
***

<br><span class="questionNumber">Q4.1</span> - Save the previous chart as a `PNG` file using the `ggsave()` function. Where is saved the file?

```{r, fig.align="center"}
# save the plot in an object called p
p <- ggplot(data, aes(x=total_bill)) +
  geom_histogram() +
  facet_grid(sex~day)

# Save the plot
ggsave(p, filename = "chartFromRPractical.png")
```


<br><span class="questionNumber">Q4.2</span> - Specify the complete path before file name to save the chart at a specific location.





# 5- Colors
***

## &rarr; One color


## &rarr; Discrete color palette

<br><span class="questionNumber">Q5.1</span> - Build a scatterplot based on the iris dataset. Use `Sepal.Length` for the X axis, `Petal.Length` for the Y axis. Use `color=Species` to color groups.
 

```{r, fig.align="center"}
ggplot(iris, aes(x=Sepal.Length, y=Petal.Length, color=Species)) +
  geom_point()
```


```{r, fig.align="center"}
ggplot(iris, aes(x=Sepal.Length, y=Petal.Length, color=Species)) +
  geom_point() +
  scale_color_manual( values=c("red","green","blue"))
```

<br><span class="questionNumber">Q5.1</span> - Build a scatterplot based on the iris dataset. Use `Sepal.Length` for the X axis, `Petal.Length` for the Y axis. Use `color=Species` to color groups.
 

```{r, fig.align="center"}
ggplot(iris, aes(x=Sepal.Length, y=Petal.Length, color=Species)) +
  geom_point() +
  scale_color_brewer(palette = "Set3")
```







## &rarr; Continuous color palette

<br><span class="questionNumber">Q5.1</span> - Build a scatterplot based on the iris dataset. Use `Sepal.Length` for the X axis, `Petal.Length` for the Y axis. Use `color=Species` to color groups.
 

```{r, fig.align="center"}
ggplot(iris, aes(x=Sepal.Length, y=Petal.Length, color=Sepal.Length)) +
  geom_point() +
  scale_color_distiller(palette = "RdPu")
```






# 6- Interactive charts
***
An interactive chart is a chart on which you can zoom, hover shapes to get tooltips, click to trigger actions and more. Building interactive charts requires javascript under the hood, but it is relatively easy to build it using R packages that wrap the javascript for you. This type of packages are called [HTML widgets](https://www.htmlwidgets.org).



## &rarr; Plotly

<br><span class="questionNumber">Q6.1</span> - Build the `gapminder` bubble plot you've already done in the annotation part of this practical. Store it in an object called `p`
```{r, fig.align="center"}
# load data
library(gapminder)
data <- gapminder %>% filter(year=="2007") %>% select(-year)

# Basic ggplot
p <- data %>%
  ggplot( aes(x=gdpPercap, y=lifeExp, size = pop, color = continent)) +
    geom_point(alpha=0.7) 
p
```


<br><span class="questionNumber">Q6.2</span> - Install and load the `plotly` package. Build an interactive chart using the `ggplotly()` function. What are the new functionalities of this chart? Is it useful? What could be better?
```{r, fig.align="center"}
# Interactive version
library(plotly)
ggplotly(p)
```





<br><span class="questionNumber">Q6.3</span> - Let's improve the tooltip of the chart:

- build a new column called `myText`. Fill it with whatever you want to show in the tooltip.
- add a new aesthetics: `text=myText`
- in the `ggplotly()` call, add `tooltip="text"`

```{r, fig.align="center"}

# Basic ggplot
p <- data %>%
  mutate(myText=paste("This country is: " , country )) %>%
  ggplot( aes(x=gdpPercap, y=lifeExp, size = pop, color = continent, text=myText)) +
    geom_point(alpha=0.7) 

ggplotly(p, tooltip="text")

```









## &rarr; HTML widgets


<br><span class="questionNumber">Q6.4</span> - `Plotly` is not the only html widget. Visit [this website](https://www.htmlwidgets.org/showcase_leaflet.html) to have an overview of what kind of interactive chart you can do with `R`.


<br><span class="questionNumber">BONUS</span> - Use the HTML widget called `dygraphs` to build an interactive line plot of the bitcoin price. Try to reproduce the example below.
```{r, fig.align="center", out.width="100%"}
# Library
library(dygraphs)
library(xts)          # To make the convertion data-frame / xts format

# Load dataset from github
data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/3_TwoNumOrdered.csv", header=T)
data$date <- as.Date(data$date)

# Then you can create the xts format, and thus use dygraph
don <- xts(x = data$value, order.by = data$date)

# Use the dygraph HTML widget
dygraph(don) %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors="#D8AE5A") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)
```







<br><span class="questionNumber">BONUS</span> - Use the HTML widget called `leaflet` to build an interactive map showing the earthquakes described in the dataset called `quakes`

```{r}
# Library
library(leaflet)
 
# load example data (Fiji Earthquakes) + keep only 100 first lines
data(quakes)
quakes =  head(quakes, 100)

# Create a color palette with handmade bins.
mybins=seq(4, 6.5, by=0.5)
mypalette = colorBin( palette="YlOrBr", domain=quakes$mag, na.color="transparent", bins=mybins)

# Final Map
leaflet(quakes) %>% 
  addTiles()  %>% 
  setView( lat=-27, lng=170 , zoom=4) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(~long, ~lat, 
    fillColor = ~mypalette(mag), fillOpacity = 0.7, color="white", radius=8, stroke=FALSE
  ) %>%
  addLegend( pal=mypalette, values=~mag, opacity=0.9, title = "Magnitude", position = "bottomright" )
```


















